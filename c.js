function CloneObject(a){return JSON.parse(JSON.stringify(a))}Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]},String.prototype.replaceAll=function(a,b){return this.replace(new RegExp(a,"g"),b)};var Chess;!function(){Chess={pieceTypes:{king:1,queen:2,rook:3,bishop:4,knight:5,pawn:6},findAttacks:function(a){function e(b,c){return a.spaces[b]&&a.spaces[b][c]?!0:!1}function f(a,c){$.each(c,function(c,d){var g,f={left:a.space.left,top:a.space.top};do f.left+=d[0],f.top+=d[1],b[f.left]&&b[f.left][f.top]&&b[f.left][f.top][a.color+"Attacks"]++,g=e(f.left,f.top);while(!g&&f.left>=0&&f.left<=7&&f.top>=0&&f.top<=7)})}for(var b=[],c=0;c<8;c++){b[c]=[];for(var d=0;d<8;d++)b[c][d]={whiteAttacks:0,blackAttacks:0}}return $(a.pieces).each(function(){var a=this,c=a.space;switch(a.type){case Chess.pieceTypes.king:for(var d=-1;d<=1;d++)for(var e=-1;e<=1;e++)(0!==d||0!==e)&&b[c.left+d]&&b[c.left+d][c.top+e]&&b[c.left+d][c.top+e][a.color+"Attacks"]++;break;case Chess.pieceTypes.bishop:f(a,[[-1,-1],[1,-1],[-1,1],[1,1]]);break;case Chess.pieceTypes.rook:f(a,[[-1,0],[1,0],[0,1],[0,-1]]);break;case Chess.pieceTypes.queen:f(a,[[-1,0],[1,0],[0,1],[0,-1],[-1,-1],[1,-1],[-1,1],[1,1]]);break;case Chess.pieceTypes.knight:$.each([[1,2],[2,1],[-1,2],[-2,1],[1,-2],[2,-1],[-1,-2],[-2,-1]],function(d,e){b[c.left+e[0]]&&b[c.left+e[0]][c.top+e[1]]&&b[c.left+e[0]][c.top+e[1]][a.color+"Attacks"]++});break;case Chess.pieceTypes.pawn:var g="white"===a.color?-1:1;$.each([-1,1],function(d,e){b[c.left+e]&&b[c.left+e][c.top+g]&&b[c.left+e][c.top+g][a.color+"Attacks"]++})}}),b},getPieceMoves:function(a,b,c,d){function e(c,d){if(c<0||c>7||d<0||d>7)return"invalid";var e=a.spaces[c][d];return e===!1?"available":e.color===b.color?"blocked":"take"}function f(a){$.each(a,function(a,c){var d={left:b.space.left,top:b.space.top};do d.left+=c[0],d.top+=c[1],k=e(d.left,d.top),("available"===k||"take"===k)&&g.push({left:d.left,top:d.top,status:k,piece:b});while("available"===k)})}var g=[],h=$(a.pieces);switch(b.type){case Chess.pieceTypes.pawn:for(var i=1;i<=(b.moved?1:2);i++){var j=b.space.top+i*("white"===b.color?-1:1),k=e(b.space.left,j);if("available"!==k)break;g.push({left:b.space.left,top:j,status:k,piece:b})}var j=b.space.top+("white"===b.color?-1:1);$.each([-1,1],function(a,d){var f=e(b.space.left+d,j);("take"===f||"available"===f&&c)&&g.push({left:b.space.left+d,top:j,status:"available"===f?"attacking":"take",piece:b})});break;case Chess.pieceTypes.knight:$.each([[1,2],[2,1],[-1,2],[-2,1],[1,-2],[2,-1],[-1,-2],[-2,-1]],function(a,c){var d=e(b.space.left+c[0],b.space.top+c[1]);("available"===d||"take"===d)&&g.push({left:b.space.left+c[0],top:b.space.top+c[1],status:d,piece:b})});break;case Chess.pieceTypes.bishop:f([[-1,-1],[1,-1],[-1,1],[1,1]]);break;case Chess.pieceTypes.rook:f([[-1,0],[1,0],[0,1],[0,-1]]);break;case Chess.pieceTypes.queen:f([[-1,0],[1,0],[0,1],[0,-1],[-1,-1],[1,-1],[-1,1],[1,1]]);break;case Chess.pieceTypes.king:for(var l={left:b.space.left,top:b.space.top},m=-1;m<=1;m++)for(var n=-1;n<=1;n++){var k=e(l.left+m,l.top+n);("available"===k||"take"===k)&&g.push({left:l.left+m,top:l.top+n,move:k,piece:b})}if(!b.moved){var o=h.filter(function(){return this.type===Chess.pieceTypes.rook&&this.color===b.color&&!this.moved}),p=[];o.each(function(){p.push(0===this.space.left?{rook:this,kingMoveSpace:{left:2,top:b.space.top},rookMoveSpace:{left:3,top:b.space.top},emptySpaces:[1,2,3]}:{rook:this,kingMoveSpace:{left:6},rookMoveSpace:{left:5},emptySpaces:[5,6]})}),$.each(p,function(a,c){0===h.filter(function(){return this.space.top===b.space.top&&c.emptySpaces.indexOf(this.space.left)>=0}).length&&g.push({left:c.kingMoveSpace.left,top:b.space.top,move:"available",piece:b})})}}return d||(g=$(g).filter(function(){var c=this,d=Chess.copyAndMove(CloneObject(a),c.piece,{left:c.left,top:c.top});return"check"!==Chess.getGameStatus(d,b.color,!0)}).toArray()),g},getAllPossibleMoves:function(a,b,c){var d=[];return $(a.pieces).each(function(){var e=this;e.color===b&&(d=d.concat(Chess.getPieceMoves(a,e,!1,c)))}),d},copyAndMove:function(a,b,c){var d=CloneObject(a),e=$(d.pieces),f=a.spaces[c.left][c.top];if(f&&(e=e.filter(function(){return this.id!==f.id}),d.pieces=e.toArray()),b.type===Chess.pieceTypes.king&&Math.abs(b.space.left-c.left)>1){var g=2===c.left?0:7,h=2===c.left?3:5,i=e.filter(function(){return this.type===Chess.pieceTypes.rook&&this.color===b.color&&this.space.left===g}).get(0);d.spaces[i.space.left][i.space.top]=!1,d.spaces[h][i.space.top]=i,i.space.left=h,i.moved=!0}var j=e.filter(function(){return this.id===b.id}).get(0);return d.spaces[j.space.left][j.space.top]=!1,d.spaces[c.left][c.top]=j,j.space=c,j.moved=!0,d},getGameStatus:function(a,b,c){var d={},e={},f=Chess.findAttacks(a),g="black"===b?"white":"black";return $(a.pieces).each(function(){this.type===Chess.pieceTypes.king&&(e[this.color]=this.space,d[this.color]=this)}),0===f[e.white.left][e.white.top].blackAttacks&&0===f[e.black.left][e.black.top].whiteAttacks?"ready":f[e[b].left][e[b].top][g+"Attacks"]>0?0===Chess.getAllPossibleMoves(a,b,c).length?("white"===b?"black":"white")+" wins":"check":"ready"}}}();var game={pieces:null,spaceElements:null,curPiece:null,turn:null,moves:null,moveShownIndex:null,players:{white:null,black:null},options:{showAttackValues:!1},start:function(){function f(b,c,d){var e=game.createPiece(b,d).appendTo(a),f={id:e.attr("id"),space:c,color:d,type:b};e.css({left:100*c.left,top:100*c.top}),game.pieces.push(f),game.spaces[c.left][c.top]=f}$(".board").remove(),game.players.white=$("#ddWhite").val(),game.players.black=$("#ddBlack").val(),"Human"!==game.players.white&&(game.players.white=engines[game.players.white]),"Human"!==game.players.black&&(game.players.black=engines[game.players.black]);var a=$("<div>",{id:"board","class":"board"}).appendTo(document.body);game.pieces=[],game.spaces=[],game.moves=[],game.turn="white",game.moveShownIndex=null;for(var b=1;b<=8;b++){for(var c=$("<div>",{"class":b%2===1?"row":"altrow"}).appendTo(a),d=1;d<=8;d++){var e=$("<div>",{"class":"space"}).appendTo(c).get(0);e.row=b-1,e.col=d-1}game.spaces[b-1]=[!1,!1,!1,!1,!1,!1,!1,!1]}game.spaceElements=a.find(".space"),$("#Scoresheet").html("<thead><tr><th></th><th>White</th><th>Black</th></tr></thead><tbody></tbody>"),$("#Score").html("");var g=[Chess.pieceTypes.rook,Chess.pieceTypes.knight,Chess.pieceTypes.bishop,Chess.pieceTypes.queen,Chess.pieceTypes.king,Chess.pieceTypes.bishop,Chess.pieceTypes.knight,Chess.pieceTypes.rook];$.each(g,function(a,b){f(b,{left:a,top:7},"white"),f(b,{left:a,top:0},"black")});for(var h=0;h<8;h++)f(Chess.pieceTypes.pawn,{left:h,top:1},"black"),f(Chess.pieceTypes.pawn,{left:h,top:6},"white");$(".piece").click(function(){var a=this,b=$(game.pieces).filter(function(){return this.id===a.id}).get(0),c=game.spaceElements.eq(b.space.left+8*b.space.top);return c.hasClass("availableSpace")||c.hasClass("availableTake")?void game.movePiece(c.get(0)):void(b.color===game.turn&&(game.curPiece=b,$(".availableSpace").removeClass("availableSpace"),$(".availableTake").removeClass("availableTake"),$.each(Chess.getPieceMoves({pieces:game.pieces,spaces:game.spaces},b),function(a,b){game.spaceElements.eq(b.left+8*b.top).addClass("available"===b.status?"availableSpace":"availableTake")})))}),"Human"!==game.players.white&&game.computerMove(),$("#board").css("margin-left",function(){return($(window).width()-$(this).width())/2-100})},createPiece:function(a,b){for(var c;!c||document.getElementById(c);)c=("piece"+Math.random()).replace(".","");var d;for(var e in Chess.pieceTypes)Chess.pieceTypes[e]===a&&(d=e);return $("<div>",{id:c,"class":"piece "+d+"-"+b+" "+b+(a===Chess.pieceTypes.pawn?" pawn":""),title:d})},movePiece:function(a){$(".availableSpace").removeClass("availableSpace"),$(".availableTake").removeClass("availableTake"),$("#Evaluations").remove();var b=$(".space").index(a),c={left:b%8,top:Math.floor(b/8)},d=$(game.pieces).filter(function(){return this.space.left===c.left&&this.space.top===c.top}).get(0);if(d&&($("#"+d.id).remove(),game.pieces.splice(game.pieces.indexOf(d),1)),game.curPiece.type===Chess.pieceTypes.king&&Math.abs(game.curPiece.space.left-c.left)>1){var e=2===c.left?0:7,f=2===c.left?3:5,g=$(game.pieces).filter(function(){return this.type===Chess.pieceTypes.rook&&this.color===game.curPiece.color&&this.space.left===e}).get(0);game.spaces[g.space.left][g.space.top]=!1,game.spaces[f][g.space.top]=g,g.space.left=f,g.moved=!0,$("#"+g.id).animate({left:100*f})}game.spaces[game.curPiece.space.left][game.curPiece.space.top]=!1,game.spaces[c.left][c.top]=game.curPiece,game.curPiece.space={left:c.left,top:c.top},game.curPiece.type===Chess.pieceTypes.pawn&&("white"===game.turn&&0===c.top||"black"===game.turn&&7===c.top)&&(game.curPiece.type=Chess.pieceTypes.queen,$("#"+game.curPiece.id).attr("title","queen").css("background-image","url('"+game.curPiece.color+" queen.png')")),game.moves.push($("#board").html()),game.turn="white"===game.turn?"black":"white";var h=Chess.getGameStatus({pieces:game.pieces,spaces:game.spaces},game.turn);game.curPiece.moved=!0;var i,j;j=game.players[game.turn].getScore?game.players[game.turn]:game.players["white"===game.turn?"black":"white"].getScore?game.players["white"===game.turn?"black":"white"]:EasyEngine,i=j.getScore({pieces:game.pieces,spaces:game.spaces},game.turn),$("#Score").html("Score: "+Math.round(100*i)/100);var k;k=void 0!==e?2===c.left?"0-0-0":"0-0":String.fromCharCode(c.left+97)+(8-c.top),"white"===game.turn?$("td","#Scoresheet").last().html(k):$("tbody","#Scoresheet").append("<tr><td>"+Math.ceil(game.moves.length/2)+"</td><td>"+k+"</td><td></td></tr>"),setTimeout(function(){$("#"+game.curPiece.id).animate({left:100*c.left,top:100*c.top},function(){"Human"===game.players[game.turn]||"ready"!==h&&"check"!==h||game.computerMove(),"ready"!==h&&"check"!==h&&alert(h)})},0),"Human"===game.players[game.turn]&&$("#board").attr("class","board"+("black"===game.turn?" flipped":"")).animate({transform:"rotate("+("white"===game.turn?"0":"180")+")"},0),game.options.showAttackValues&&game.updateAttacks()},updateAttacks:function(){var a=Chess.findAttacks({pieces:game.pieces,spaces:game.spaces});$(".space").html(function(b){var c=a[b%8][Math.floor(b/8)];return c.whiteAttacks+" / "+c.blackAttacks})},computerMove:function(){var a=game.players[game.turn].getMove({pieces:game.pieces,lastMoved:game.curPiece,spaces:game.spaces},game.turn);a&&(game.curPiece=a.piece,game.movePiece($(".space").get(a.left+8*a.top)))},getPieceName:function(a){for(var b in Chess.pieceTypes)if(a===Chess.pieceTypes[b])return b}};$(function(){var a=$("<div>",{id:"ControlPanel"}).appendTo(document.body);$.each(["White","Black"],function(b,c){$("<label>",{"for":"dd"+c,html:c}).appendTo(a);var d=$("<select>",{id:"dd"+c,html:"<option value='Human'>Human</option>",val:"White"===c?"Human":"Computer"}).appendTo(a);for(var e in engines)$("<option>",{val:e,html:e}).appendTo(d);"Black"===c&&d.val("Easy"),$("<br>").appendTo(a)}),$.each(["Show Attack Values"],function(b,c){var d="cb"+c.replaceAll(" ","");$("<input>",{type:"checkbox",id:d,val:"Yes"}).appendTo(a),$("<label>",{"for":d,html:c}).appendTo(a),$("<br>").appendTo(a)}),$("<label>",{id:"Score",css:{display:"block"}}).appendTo(a),$("<input>",{type:"button",val:"New Game",click:game.start}).appendTo(a),$("<input>",{type:"button",val:"Hint",click:function(){var a=game.players["white"===game.turn?"black":"white"].evaluateAllmoves({pieces:game.pieces,lastMoved:game.curPiece,spaces:game.spaces},game.turn).moveEvaluations,b=$("<table>",{id:"Evaluations"}).appendTo(document.body);$.each(a,function(a,c){$("<tr>",{html:"<td>"+c.move+"</td><td>"+c.score+"</td>"}).appendTo(b)})}}).appendTo(a),$("<table>",{id:"Scoresheet"}).appendTo(document.body).wrap("<div id='ScoresheetBox'></div>"),game.start(),$(document.body).on("click",".availableSpace, .availableTake",function(){game.movePiece(this)}),$("#cbShowAttackValues").change(function(){game.options.showAttackValues=this.checked,game.options.showAttackValues?game.updateAttacks():$(".space").html("")}),$(document.body).on("mousewheel",".board",function(a){var b=a.originalEvent.wheelDelta>0?!0:!1;if(null===game.moveShownIndex&&(game.moveShownIndex=game.moves.length-1),game.moveShownIndex+(b?1:-1)>=0&&game.moveShownIndex+(b?1:-1)<=game.moves.length){if($(".activeMove").removeClass("activeMove"),$(".pastMove").remove(),game.moveShownIndex+(b?1:-1)==game.moves.length)return game.moveShownIndex=null,void $("#board").show();var c=game.moves[game.moveShownIndex];$("#board").hide(),$("<div>",{"class":"board pastMove",html:c}).appendTo(document.body),$("td:not(:first-child)","#Scoresheet").eq(game.moveShownIndex-1).addClass("activeMove"),game.moveShownIndex+=b?1:-1}})});var RandomEngine={getMove:function(a,b){var c=Chess.getAllPossibleMoves(a,b);return c.length>0?c.random():void 0},getScore:function(){return 0}},EasyEngine={evaluateAllmoves:function(a,b){var d,c=Chess.getAllPossibleMoves(a,b),e=[],f="white"===b?-50:50;return $.each(c,function(c,d){var g=Chess.copyAndMove(a,d.piece,{top:d.top,left:d.left}),h=Chess.getAllPossibleMoves(g,"white"===b?"black":"white"),i="white"===b?50:-50;$.each(h,function(a,c){var d=Chess.copyAndMove(g,c.piece,{top:c.top,left:c.left}),e=EasyEngine.getScore(d,b);("white"===b&&e<i||"black"===b&&e>i)&&(i=e)}),d.bestOppScore=i,("white"===b&&i>=f||"black"===b&&i<=f)&&(i===f?e.push(d):(f=i,e=[d]))}),c.sort(function(a,c){return a.bestOppScore===c.bestOppScore?0:(a.bestOppScore<c.bestOppScore?-1:1)*("white"===b?-1:1)}),d=$(c).map(function(){var a=String.fromCharCode(this.left+97)+(8-this.top);return{move:game.getPieceName(this.piece.type)+" to "+a,score:Math.floor(100*this.bestOppScore)/100}}).toArray(),{bestMoves:e,allPossibleMoves:c,moveEvaluations:d}},getMove:function(a,b){return EasyEngine.evaluateAllmoves(a,b).bestMoves.random()},getScore:function(a){var c={white:{material:0,space:0},black:{material:0,space:0}};$.each(a.pieces,function(a,b){switch(b.type){case Chess.pieceTypes.pawn:c[b.color].material++;break;case Chess.pieceTypes.bishop:case Chess.pieceTypes.knight:c[b.color].material+=3;break;case Chess.pieceTypes.rook:c[b.color].material+=5;break;case Chess.pieceTypes.queen:c[b.color].material+=9}});for(var d=Chess.findAttacks(a),e=0;e<8;e++)for(var f=0;f<8;f++){var g=d[e][f],h=8-Math.floor(Math.abs(e-3.5))-Math.floor(Math.abs(f-3.5));g.whiteAttacks>g.blackAttacks?c.white.space+=h*(0===g.blackAttacks?3:1):g.blackAttacks>g.whiteAttacks&&(c.black.space+=h*(0===g.whiteAttacks?3:1))}return 10*(c.white.material/c.black.material-1)+(c.white.space/c.black.space-1)}},SmarterEngine={getMove:function(a,b){var c=Chess.getAllPossibleMoves(a,b),d=[],e="white"===b?-50:50;return $.each(c,function(c,f){var g=Chess.copyAndMove(a,f.piece,{top:f.top,left:f.left}),h=Chess.getAllPossibleMoves(g,"white"===b?"black":"white"),i="white"===b?50:-50;$.each(h,function(a,c){var d=Chess.copyAndMove(g,c.piece,{top:c.top,left:c.left}),e=SmarterEngine.getScore(d,b);("white"===b&&e<i||"black"===b&&e>i)&&(i=e)}),f.bestOppScore=i,("white"===b&&i>=e||"black"===b&&i<=e)&&(i===e?d.push(f):(e=i,d=[f]))}),d.random()},getScore:function(a){var c={white:{material:0,space:0,development:0},black:{material:0,space:0,development:0}};$.each(a.pieces,function(a,b){switch(b.type){case Chess.pieceTypes.pawn:c[b.color].material++;break;case Chess.pieceTypes.bishop:case Chess.pieceTypes.knight:c[b.color].material+=3,b.moved&&(c[b.color].development+=3);break;case Chess.pieceTypes.rook:c[b.color].material+=5;break;case Chess.pieceTypes.queen:c[b.color].material+=9,b.moved&&(c[b.color].development+=.5)}});for(var d=Chess.findAttacks(a),e=0;e<8;e++)for(var f=0;f<8;f++){var g=d[e][f],h=8-Math.floor(Math.abs(e-3.5))-Math.floor(Math.abs(f-3.5));g.whiteAttacks>g.blackAttacks?c.white.space+=h*(0===g.blackAttacks?3:1):g.blackAttacks>g.whiteAttacks&&(c.black.space+=h*(0===g.whiteAttacks?3:1))}return 10*(c.white.material/c.black.material-1)+(c.white.space/c.black.space-1)+(c.white.development/c.black.development-1)}},TwoMoves={getMove:function(a,b){var d,c=Chess.getAllPossibleMoves(a,b),e="white"===b?-50:50,f="white"===b?"black":"white";return $.each(c,function(c,g){var h=Chess.copyAndMove(a,g.piece,{top:g.top,left:g.left}),i=Chess.getAllPossibleMoves(h,f),j="white"===b?50:-50;$.each(i,function(a,c){c.boardAfterMove=Chess.copyAndMove(h,c.piece,{top:c.top,left:c.left}),c.score=TwoMoves.getScore(c.boardAfterMove,b)}),i.sort(function(a,b){return a.score===b.score?0:a.score<b.score?-1:1}),"black"===b?i.splice(.2*i.length):i=i.splice(.2*i.length),$.each(i,function(a,c){var d=c.boardAfterMove,e=Chess.getAllPossibleMoves(d,b);$.each(e,function(a,c){var e=Chess.copyAndMove(d,c.piece,{top:c.top,left:c.left}),g=Chess.getAllPossibleMoves(e,f);$.each(g,function(a,c){var d=Chess.copyAndMove(e,c.piece,{top:c.top,left:c.left}),f=SmarterEngine.getScore(d,b);("white"===b&&f<j||"black"===b&&f>j)&&(j=f)})})}),g.bestOppScore=j,("white"===b&&j>e||"black"===b&&j<e)&&(e=j,d=g)}),d},getScore:EasyEngine.getScore},engines={Easy:EasyEngine,Random:RandomEngine,Smarter:SmarterEngine,TwoMoves:TwoMoves};